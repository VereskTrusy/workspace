<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.prod.dao.ProdDAO">
	<!-- 수동 맵핑 설정 -->
	<!-- type="ProdVO" : 최종 반환 타입 -->
	<!-- autoMapping="true" : 단순 컬럼의 내용은 자동 바인딩 -->
	<!-- association :  연관관계, vo멤버변수와 vo멤버변수에 해당하는 VO 수동 연결 -->
	<resultMap type="ProdVO" id="prodMap" autoMapping="true">
		<id property="prodId" column="PROD_ID" />
		<association property="buyer" javaType="BuyerVO" autoMapping="true" />
		<association property="lprod" javaType="LprodVO" autoMapping="true" />
		<collection property="cartList" ofType="CartVO" autoMapping="true">
			<association property="member" javaType="MemberVO" autoMapping="true" />
		</collection>
	</resultMap>
	
	<select id="selectProdList" resultMap="prodMap">
		SELECT
			  PROD.PROD_ID /* 상품코드 */
			, PROD.PROD_BUYER /* 거래처 */
			, PROD.PROD_LGU /* 상품분류 */
			, PROD.PROD_NAME /* 상품명 */
			, PROD.PROD_COST /* 구매가 */
			, PROD.PROD_PRICE /* 판매가 */
			, PROD.PROD_MILEAGE /* 마일리지 */
			, PROD.PROD_INSDATE /* 입고일 */
		    , BUYER.BUYER_NAME /* 거래처명 */
		    , LPROD.LPROD_NM /* 분류명 */
		FROM PROD
		INNER JOIN BUYER ON (PROD.PROD_BUYER = BUYER.BUYER_ID)
		INNER JOIN LPROD ON (PROD.PROD_LGU = LPROD.LPROD_GU)
	</select>
	
	<select id="selectProd" resultMap="prodMap" parameterType="String">
		WITH CARTMEM AS (
		    SELECT 
		        DISTINCT CART.CART_MEMBER
		        , CART.CART_PROD
		        , MEMBER.MEM_NAME
		        , MEMBER.MEM_MAIL
		    FROM CART INNER JOIN MEMBER ON (CART.CART_MEMBER = MEMBER.MEM_ID)
		)
		SELECT
			  PROD.PROD_ID /* 상품코드 */
			, PROD.PROD_NAME /* 상품명 */
			, PROD.PROD_LGU /* 상품분류 */
			, PROD.PROD_BUYER /* 거래처 */
			, PROD.PROD_COST /* 구매가 */
			, PROD.PROD_PRICE /* 판매가 */
			, PROD.PROD_SALE /* 세일가 */
			, PROD.PROD_OUTLINE /* 요약정보 */
			, PROD.PROD_DETAIL /* 상세정보 */
			, PROD.PROD_IMG /* 이미지 */
			, PROD.PROD_TOTALSTOCK /* 총재고 */
			, PROD.PROD_INSDATE /* 입고일 */
			, PROD.PROD_PROPERSTOCK /* 적정재고 */
			, PROD.PROD_SIZE /* 크기 */
			, PROD.PROD_COLOR /* 색상 */
			, PROD.PROD_DELIVERY /* 배송방법 */
			, PROD.PROD_UNIT /* 단위 */
			, PROD.PROD_QTYIN /* 입고량 */
			, PROD.PROD_QTYSALE /* 출고량 */
			, PROD.PROD_MILEAGE /* 마일리지 */
			, BUYER.BUYER_ID /* 거래처아이디 */
			, BUYER.BUYER_NAME /* 거래처명 */
			, BUYER.BUYER_LGU /* 거래처코드 */
			, BUYER.BUYER_BANK /* 은행명 */
			, BUYER.BUYER_BANKNO /* 계좌번호 */
			, BUYER.BUYER_BANKNAME /* 예금주명 */
			, BUYER.BUYER_ZIP /* 우편번호 */
			, BUYER.BUYER_ADD1 /* 기본주소 */
			, BUYER.BUYER_ADD2 /* 상세주소 */
			, BUYER.BUYER_COMTEL /* 회사전화번호 */
			, BUYER.BUYER_FAX /* 팩스번호 */
			, BUYER.BUYER_MAIL /* 이메일 */
			, BUYER.BUYER_CHARGER /* 담당자 */
			, BUYER.BUYER_TELEXT /* 전화번호? */
			, LPROD.LPROD_ID /* 상품순번 */
			, LPROD.LPROD_GU /* 상품분류코드 */
			, LPROD.LPROD_NM /* 상품분류명 */
			, CART_MEMBER
		    , CART_PROD
		    , MEM_NAME
		    , MEM_MAIL
		FROM PROD
		INNER JOIN BUYER ON (PROD.PROD_BUYER = BUYER.BUYER_ID)
		INNER JOIN LPROD ON (PROD.PROD_LGU = LPROD.LPROD_GU)
    	LEFT OUTER JOIN CARTMEM ON (PROD.PROD_ID = CARTMEM.CART_PROD)
		WHERE 1=1
		AND PROD.PROD_ID = #{prodId}
	</select>
	
	<insert id="insertProd" parameterType="ProdVO">
		<selectKey order="BEFORE" resultType="String" keyProperty="prodId" >
			SELECT 
				#{prodLgu} || LPAD(NVL(TO_NUMBER(SUBSTR(MAX(PROD_ID), 5)), 0) + 1, 6, '0')
			FROM PROD
			WHERE PROD_LGU = #{prodLgu}
		</selectKey>
		INSERT INTO PROD(
			  PROD_ID
			, PROD_NAME
			, PROD_LGU
			, PROD_BUYER
			, PROD_COST
			, PROD_PRICE
			, PROD_SALE
			, PROD_OUTLINE
			, PROD_DETAIL
			, PROD_IMG
			, PROD_TOTALSTOCK
			, PROD_INSDATE
			, PROD_PROPERSTOCK
			, PROD_SIZE
			, PROD_COLOR
			, PROD_DELIVERY
			, PROD_UNIT
			, PROD_QTYIN
			, PROD_QTYSALE
			, PROD_MILEAGE
		)VALUES(
			  #{prodId, jdbcType=VARCHAR }
			, #{prodName, jdbcType=VARCHAR }
			, #{prodLgu, jdbcType=VARCHAR }
			, #{prodBuyer, jdbcType=VARCHAR }
			, #{prodCost, jdbcType=NUMERIC}
			, #{prodPrice, jdbcType=NUMERIC}
			, #{prodSale, jdbcType=NUMERIC}
			, #{prodOutline, jdbcType=VARCHAR }
			, #{prodDetail, jdbcType=VARCHAR }
			, #{prodImg, jdbcType=VARCHAR }
			, #{prodTotalstock, jdbcType=NUMERIC}
			, #{prodInsdate, jdbcType=DATE}
			, #{prodProperstock, jdbcType=NUMERIC}
			, #{prodSize, jdbcType=VARCHAR }
			, #{prodColor, jdbcType=VARCHAR }
			, #{prodDelivery, jdbcType=VARCHAR }
			, #{prodUnit, jdbcType=VARCHAR }
			, #{prodQtyin, jdbcType=NUMERIC}
			, #{prodQtysale, jdbcType=NUMERIC}
			, #{prodMileage, jdbcType=NUMERIC}
		)
		
	</insert>
</mapper>